# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Scan Image

on:
  workflow_dispatch:
    inputs:
      imageDigest:
        description: 'Image Digest'
        required: true
        default: ''

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/download/v0.40.0/trivy_0.40.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.40.0_Linux-64bit.deb
      - name: Scan image with Trivy
        id: scan-image
        run: |
          trivy image --format json --output scan-results.json '${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.IMAGE_REPO }}:${{ github.event.inputs.imageDigest }}' --username ${{ secrets.ACR_USER_NAME }} --password ${{ secrets.ACR_PASSWORD }} --timout 20m
      